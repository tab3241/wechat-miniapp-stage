"use strict";function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(n,!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(n).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var config={version:"1.1.0",startAllergy:!0,lt:2,server:{domain:"https://stm-collect.cn.miaozhen.com/",getPath:"track_proxy",postPath:"track_ajax"},query:{la:"la",lb:"lb",ks:"_smwt_ks",kn:"_smwt_kn",kr:"_smwt_kr"},titleKey:"smwtTitle",storage:{log:"_smwt_ev",cid:"_smwt_cid",openid:"_smwt_openid",unionid:"_smwt_unid",share:"_smwt_sha"},switchs:{autoPV:!0},blackPVList:[],whitePVList:[],userTrackHanders:["event","pageview"],beats:{five:[5,15,30,60,120],one:[0]},maxLogLength:1024,params:["t","tid","cid","lt","appid","pdur","dur","openid","unionid","sc","la","lb","scene","model","plr","appv","os","osv","net","ni","sr","vp","ul","latitude","longitude","ks","kn","kr","kt","kif","ec","ea","el","ev","cd[0-9]*","cm[0-9]*","caid","cal[0-9]*","cav[0-9]*","dl","dp","dt","q[a-g]{1}","sdkv","z"]},_={_ow:function(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];var o=n.shift();if(o=o||{},1===n.length){var i=n[0]||{};Object.keys(i).forEach(function(e){(t||e in o)&&(o[e]=i[e])})}else n.forEach(function(e){_.extend(o,e)});return o},extend:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return _._ow.apply(_,[!0].concat(t))},default:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return _._ow.apply(_,[!1].concat(t))},pick:function(n,e){return n&&e&&e.reduce&&e.reduce(function(e,t){return t in n&&(e[t]=n[t]),e},{})||{}},fromPairs:function(e){return e&&e.reduce&&e.reduce(function(e,t){return 2===t.length&&t[0]&&(e[t[0]]=t[1]),e},{})||{}},hash:function(e){var t,n=1,r=0;if(e)for(n=0,t=e.length-1;0<=t;t--)n=0!==(r=266338304&(n=(n<<6&268435455)+(r=e.charCodeAt(t))+(r<<14)))?n^r>>21:n;return n},uuid:function(e){var t=Math.round(2147483647*Math.random()),n=e.model+e.platform+e.system+e.version+e.SDKVersion;return[Math.round((new Date).getTime()/1e3),t^2147483647&_.hash(n)].join("").substr(0,18)},dismantlePath:function(e){var t=(e||"").split("?");return{url:t[0],query:_.fromPairs((t[1]||"").split("&").map(function(e){return e.split("=")}))}},formPath:function(t,e){var n=1<arguments.length&&void 0!==e&&e,r=t.url||"",o=t.query&&Object.keys(t.query).length&&(-1<r.indexOf("?")?"&":"?")||"",i=t.query&&Object.keys(t.query).map(function(e){return"".concat(e,"=").concat(n&&encodeURIComponent(t.query[e])||t.query[e])}).join("&")||"";return"".concat(r).concat(o).concat(i)},proxy:function(e,s,t){if(!e)return function(){};var a=!1,c=t&&t.before||t||function(){},u=t&&t.after||function(){},n=!("force"in t)||t.force,f=e[s];return n||f?(e[s]=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];if(a)return f&&f.apply&&f.apply(this,n);function o(){return u&&u.apply&&u.apply(e,[i].concat(n))}var i={};try{c&&c.apply&&c.apply(this,[i].concat(n))}catch(e){_.log("proxy","before(".concat(s,") error: ").concat(e))}i.result=f&&f.apply&&f.apply(this,n);try{i.result&&"function"==typeof i.result.then?i.result.then(function(e){i.result=e,o()}):o()}catch(e){_.log("proxy","after(".concat(s,") error: ").concat(e))}return i.result},function(){return a=!a}):function(){}},ctrl:function(e,r){var o=this;return function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};try{var n=r(t);n&&Object.keys(n).forEach(function(e){return _.proxy(t,e,n[e])})}catch(e){_.log("ctrl",e)}return e&&e.call&&e.call(o,t)}},clean:function(n){var r={};return Object.keys(n).forEach(function(e){var t=n[e];""!==t&&(r[e]=_.encryptValue(t,e)),"sc"===e&&0===t&&delete r[e]}),r},cleanAndsort:function(r){var o={},t=Object.keys(r);try{config.params.forEach(function(e){var n=new RegExp("^"+e+"$");t.forEach(function(e){var t=r[e];n.test(e)&&(""!==t&&(o[e]=_.encryptValue(t,e)),"sc"===e&&0===t&&delete o[e])})})}catch(e){o=_.clean(r),_.log("cleanAndsort",e)}return o},encryptValue:function(t,n){if(!config.startAllergy)return t;var r=!1;if(["cd[0-9]*","ec","ea","el","cal[0-9]*"].forEach(function(e){new RegExp("^"+e+"$").test(n)&&(r=!0)}),!r)return t;try{var e=function(e){for(var t="",n=0;n<e;n++)t+="*";return t};if(/^(?:(?:\+|00)86)?1[3-9]\d{9}$/.test(t))return t=String(t),"".concat(t.slice(0,t.length-8)).concat(e(4)).concat(t.slice(-4));if(/(^[1-9]\d{7}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}$)|(^[1-9]\d{5}(18|19|([23]\d))\d{2}((0[1-9])|(10|11|12))(([0-2][1-9])|10|20|30|31)\d{3}[0-9Xx]$)/.test(t))return t=String(t),"".concat(t.slice(0,4)).concat(e(t.length-6)).concat(t.slice(-2));if(/^(?:[a-zA-Z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-zA-Z0-9!#$%&'*+/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9-]*[a-zA-Z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-zA-Z0-9-]*[a-zA-Z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)])$/.test(t)){var o=t.split("@");if(1===o[0].length)return"*@".concat(o[1]);if(o[0].length<=10)return"".concat(t.slice(0,1)).concat(e(o[0].length-1),"@").concat(o[1]);if(10<o[0].length)return"".concat(t.slice(0,1)).concat(e(9),"@").concat(o[1])}return t}catch(e){return _.log("encryptValue",e),t}},getCurrentPage:function(){var e="",t="",n="";try{var r=getCurrentPages();if(r&&r.length){var o=r[r.length-1],i=o.options||{},s=Object.keys(i).map(function(e){return e+"="+i[e]});e=o.route,t=s.length?"?"+s.join("&"):"",n=o[config.titleKey]}}catch(e){_.log("getCurrentPage",e)}return{url:e,query:t,title:n}},setStorage:function(e,t){return wx.setStorageSync(e,t)},getStorage:function(e){return wx.getStorageSync(e)},delStorage:function(e){return wx.removeStorageSync(e)},log:function(e,t,n){var r=2<arguments.length&&void 0!==n?n:2;try{var o=_.getStorage(config.storage.log)||[];o.push({t:Math.floor((new Date).getTime()/1e3),n:e,e:String(t&&t.message||t.errMsg||t),l:r}),function e(){JSON.stringify(o).replace(/[^\u0000-\u00ff]/g,"aa").length<=config.maxLogLength||(o.shift(),e())}(),_.setStorage(config.storage.log,o)}catch(e){return}}},status={_beats:{},_beatsDone:0,_session:!0,alive:!1,running:!1,beating:!1,sharing:!1,shareNeedSend:!1,shareTNeedSend:!1,start:function(){status.alive=!0,status.running=!0},stop:function(){status.running=!1},live:function(e){var t=0<arguments.length&&void 0!==e?e:config.beats.five;Object.keys(status._beats).forEach(function(e){return clearTimeout(status._beats[e])}),status._beatsDone=t.length,status._beats=_.fromPairs(t.map(function(e){return[e,null]})),Object.keys(status._beats).forEach(function(e){status._beats[e]=setTimeout(function(){tracker.track("pulse"),--status._beatsDone<=0&&(status.beating=!1)},1e3*+e)}),status.beating=!0},session:function(){return 0}},infos={_user:{},user:{},system:{},custom:{dimensions:{},metrics:{}},kif:"",pageStartT:0,init:function(e){var t=e&&e.appid||"",n=e&&e.trackid||"",r=_.getStorage(config.storage.cid)||"",o=_.getStorage(config.storage.openid)||"",i=_.getStorage(config.storage.unionid)||"",s=wx.getSystemInfoSync();r||(r=_.uuid(s),_.setStorage(config.storage.cid,r)),_.extend(infos.system,{sdkv:config.version,tid:n,appid:t,cid:r,openid:o,unionid:i,sc:0,la:"",lb:"",scene:0,model:s.model,plr:s.pixelRatio,appv:"",os:s.platform,osv:s.system,sr:"".concat(s.screenWidth,"*").concat(s.screenHeight),vp:"".concat(s.windowWidth,"*").concat(s.windowHeight),ul:s.language,latitude:"",longitude:"",net:"",ni:1,dur:0}),_.extend(infos._user,{avatarUrl:"",city:"",country:"",gender:"",language:"",nickName:"",province:""}),wx.getNetworkType({success:function(e){infos.system.net=e.networkType},fail:function(e){_.log("getNetworkType",e)}})},setOpenId:function(e){_.setStorage(config.storage.openid,e),infos.system.openid=e},setUnionId:function(e){_.setStorage(config.storage.unionid,e),infos.system.unionid=e},setUser:function(e){_.default(infos._user,e),infos.user={qa:infos._user.avatarUrl,qb:infos._user.city,qc:infos._user.country,qd:infos._user.gender,qe:infos._user.language,qf:infos._user.nickName,qg:infos._user.province}},setAppVersion:function(e){infos.system.appv=e},setReferrer:function(e){_.extend(infos.system,{scene:e.scene||0,la:e.query[config.query.la]||"",lb:e.query[config.query.lb]||""})},share:function(o){var i=!1,e=["ks","kn","kr"],s=_.getStorage(config.storage.share)||_.fromPairs(e.map(function(e){return[e,""]}));if(!o)return s;e.forEach(function(e){var t=s[e],n=config.query[e],r=o.query[n]||"";t!=r&&(i=!0,s[e]=r||"")}),status.shareNeedSend=!0,i&&_.setStorage(config.storage.share,s),o.shareTicket&&wx.getShareInfo&&wx.getShareInfo({shareTicket:o.shareTicket,success:function(e){status.shareTNeedSend=!0,infos.kif=JSON.stringify(e)}})},option:function(e){if(!e)return config.switchs;_.default(config.switchs,e),config.blackPVList=e.blackPVList||[],config.whitePVList=e.whitePVList||[]},getLocation:function(){if(!infos.system.latitude||!infos.system.longitude)try{wx.getLocation&&wx.getLocation({type:"wgs84",success:function(e){_.extend(infos.system,{latitude:e.latitude,longitude:e.longitude})},fail:function(e){_.log("getLocation",e)}})}catch(e){_.log("getLocation",e)}},setDur:function(e){infos.system.dur||(infos.system.dur=+e<0?0:+e)},setPageStartT:function(e){infos.pageStartT=e||0},setCustomDimension:function(e,t){e=String(e);for(var n=0;n<20;n++){e!=="dimension".concat(n+1)||null==t||Number.isNaN(t)||1/0===t||-1/0===t||(infos.custom.dimensions["cd".concat(n+1)]=t)}},delCustomDimension:function(e){delete infos.custom.dimensions[e.replace("dimension","cd")]},setCustomMetric:function(e,t){e=String(e);for(var n=0;n<20;n++){e==="metric".concat(n+1)&&0<=+t&&(infos.custom.metrics["cm".concat(n+1)]=+t)}},delCustomMetric:function(e){delete infos.custom.metrics[e.replace("metric","cm")]},check:function(){try{0<parseInt(infos.system.scene)||infos.setReferrer(wx.getLaunchOptionsSync())}catch(e){_.log("check",e)}}},tracker={thandlers:{log:function(){return{log:_.getStorage(config.storage.log)||{}}},pulse:function(){return _.pick(infos.system,["tid","cid","sc","ni","sr","vp","ul","dur"])},pageview:function(e){var t=0<arguments.length&&void 0!==e?e:0,n={};return status.shareNeedSend&&(n=_.getStorage(config.storage.share),status.shareNeedSend=!1),status.shareTNeedSend&&(n.kif=infos.kif,status.shareTNeedSend=!1),_objectSpread({},infos.system,{},infos.user,{},infos.custom.dimensions,{},infos.custom.metrics,{ni:0,sc:status.session(),pdur:t},n)},event:function(e,t,n,r){var s=0<arguments.length&&void 0!==e?e:"",o=1<arguments.length&&void 0!==t?t:"",i=2<arguments.length&&void 0!==n?n:"",a=3<arguments.length&&void 0!==r?r:"",c=_objectSpread({},infos.system,{},infos.user,{},infos.custom.dimensions,{},infos.custom.metrics,{ni:0});return s.constructor===Object&&"number"==typeof s.customActionId?(c.caid=s.customActionId,Array.from({length:19}).forEach(function(e,t){var n="customActionLabel".concat(t+1),r=s[n],o="customActionValue".concat(t+1),i=+s[o];n in s&&r.substring&&(c["cal".concat(t+1)]=r),o in s&&0<=+i&&(c["cav".concat(t+1)]=+i)}),c):_objectSpread({},c,{ec:s,ea:o,el:i,ev:a})},share:function(e){return _objectSpread({},infos.system,{},infos.user,{},infos.custom.dimensions,{},infos.custom.metrics,{kt:JSON.stringify(e)})}},userTrack:function(e){for(var t=arguments.length,n=new Array(1<t?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];var o=(new Date).getTime();if(-1<config.userTrackHanders.indexOf(e)){if("pageview"!==e)return tracker.track.apply(this,arguments);var i=o-infos.pageStartT;return i=i<0?0:i,tracker.userTrackHandle.apply(this,[e,i].concat(n))}_.log("userTrack","t is not allowed! t: ".concat(e),1)},userTrackHandle:function(e,t,n,r){var o={},i=_.getCurrentPage();if(status.running&&infos.system.tid){if(!(e in tracker.thandlers))return _.log("userTrackHandle","handler is not found! t: ".concat(e),1);_.extend(o,tracker.thandlers[e]()||{}),infos.check(),tracker.send(_.cleanAndsort(_objectSpread({t:e},o,{lt:config.lt,dl:i.url+i.query,dp:(arguments.length<=2?void 0:n)||"",dt:(arguments.length<=3?void 0:r)||i.title||"",z:"".concat((new Date).getTime(),"_").concat(Math.round(1e4*Math.random()))})))}},track:function(e){var t={},n=_.getCurrentPage();if(status.running&&infos.system.tid&&("pageview"!==e||!config.switchs.autoPV||!config.blackPVList.includes(n.url))&&("pageview"!==e||config.switchs.autoPV||config.whitePVList.includes(n.url))){if(!(e in tracker.thandlers))return _.log("track","handler is not found! t: ".concat(e),1);for(var r,o=arguments.length,i=new Array(1<o?o-1:0),s=1;s<o;s++)i[s-1]=arguments[s];_.extend(t,(r=tracker.thandlers)[e].apply(r,i)||{}),infos.check(),tracker.send(_.cleanAndsort(_objectSpread({t:e},t,{lt:config.lt,dl:n.url+n.query,dt:n.title||"",z:"".concat((new Date).getTime(),"_").concat(Math.round(1e4*Math.random()))})))}},send:function(t){var e=_.formPath({query:t},!0),n="",r="GET",o={};if(e.length<=2036)n=config.server.getPath,r="GET";else{if(!(e.length<=8192))return _.log("send","query too long");n=config.server.postPath,t=e.substring(1),r="POST",o["content-type"]="text/plain"}return new Promise(function(e){wx.request({url:"".concat(config.server.domain).concat(n),data:t,method:r,header:o,success:e,fail:function(e){_.log("send",e,2)}})})}},createPageCtrlContext=function(e){var t=0,n=0;return{pageLoad:function(){},pageView:{after:function(){n=(new Date).getTime(),infos.setPageStartT(n),function(){if(status.sharing)return status.sharing=!1;tracker.track("pageview",t)}()}},pageReady:function(){t=(t=(new Date).getTime()-n)<0?0:t},onShareAppMessage:{force:!1,after:function(e){var t,n=e.result||{},r=_.getCurrentPage(),o=_.dismantlePath(n.path||"".concat(r.url).concat(r.query)),i=infos.share();status.sharing=!0,Object.keys(config.query).forEach(function(e){return delete o.query[config.query[e]]}),_.extend(o.query,(_defineProperty(t={},config.query.ks,infos.system.cid),_defineProperty(t,config.query.kn,(+i.kn||0)+1),_defineProperty(t,config.query.kr,i.kr||infos.system.cid),t)),n.title=n.title||r.title||"",n.path=_.formPath(o),e.result=n,tracker.track("share",n)}},onHide:function(){console.log("sdk onHide"),tracker.track("pulse")},onUnload:function(){console.log("sdk onUnload"),tracker.track("pulse")}}};App=_.ctrl(App,function(e){var n=0;return{onLaunch:{before:function(){this.smwt=_app,infos.setDur(0),n=(new Date).getTime()}},onHide:function(){},onError:function(e,t){tracker.track("error",t)},onShow:function(e,t){infos.setReferrer(t),infos.share(t),infos.setDur((new Date).getTime()-n)}}}),Page=_.ctrl(Page,function(e){var t=createPageCtrlContext(e);return{onReady:t.pageReady,onShow:t.pageView,onShareAppMessage:t.onShareAppMessage,onHide:t.onHide,onUnload:t.onUnload}}),Component=_.ctrl(Component,function(e){var t=e.methods,n=createPageCtrlContext(e);_.proxy(t,"onLoad",n.pageLoad),_.proxy(t,"onShow",n.pageView),_.proxy(t,"onShareAppMessage",n.onShareAppMessage),_.proxy(t,"onHide",n.onHide),_.proxy(t,"onUnload",n.onUnload)});var _app={version:config.version,start:status.start,stop:status.stop,option:infos.option,setOpenId:infos.setOpenId,setUnionId:infos.setUnionId,setUser:infos.setUser,setAppVersion:infos.setAppVersion,setCD:infos.setCustomDimension,setCM:infos.setCustomMetric,delCD:infos.delCustomDimension,delCM:infos.delCustomMetric,track:tracker.userTrack};try{var option=require("./sm_wx_option.js");infos.init(option),_app.option(option),_app.start(),module.exports=_app}catch(e){}